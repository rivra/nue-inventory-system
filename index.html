 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUE Inventory</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: system-ui; text-align: center; background: #fafafa; padding: 20px; }
        #reader { width: 100%; max-width: 400px; margin: auto; border-radius: 12px; }
        .panel { display: none; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 20px; }
        button { padding: 15px 25px; margin: 10px; border: none; border-radius: 8px; font-weight: bold; color: white; }
        .btn-in { background: #27ae60; }
        .btn-out { background: #c0392b; }
        #status { margin-top: 15px; font-weight: 600; }
    </style>
</head>
<body>
    <h1>NUE Inventory Scanner</h1>
    <div id="scanner-container">
        <video id="video" style="width: 100%; max-width: 400px; border-radius: 10px;"></video>
    </div>
    <div id="status">Ready to scan</div>

    <div id="controlPanel" class="panel">
        <p>Serial Code: <span id="codeDisplay">---</span></p>
        <button class="btn-in" onclick="sendToGoogle('IN')">Stock IN (+1)</button>
        <button class="btn-out" onclick="sendToGoogle('OUT')">Stock OUT (-1)</button>
        <button style="background:#7f8c8d" onclick="restartScanner()">Scan New</button>
    </div>

    <audio id="beep" src="https://actions.google.com/sounds/v1/communication/notification_high_intensity.ogg"></audio>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzbuNC1D1S_pJrn6KzKUHONq-6Gk5K7beewTzooorOa3DEc4MKhs5zgoMgX6AhwXj_p/exec";
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const videoElement = document.getElementById('video');
        let activeCode = "";

        async function sendToGoogle(action) {
            document.getElementById('status').innerText = "Sending to Database...";
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Critical for Google Apps Script redirects
                    body: JSON.stringify({ barcode: activeCode, action: action })
                });
                
                // Note: with no-cors, we can't read the JSON response directly, 
                // but the data will still be updated in the Sheet.
                document.getElementById('beep').play();
                document.getElementById('status').innerText = "Update Sent!";
            } catch (err) {
                document.getElementById('status').innerText = "Error!";
            }
        }

        function restartScanner() {
            document.getElementById('controlPanel').style.display = "none";
            document.getElementById('status').innerText = "Ready to scan";
            startScanner();
        }
        
        async function startScanner() {
            try {
                // Get all video devices
                const videoInputDevices = await codeReader.listVideoInputDevices();

    	        // 1. Filter for the best "Back" camera
                // iPhones usually name the telephoto lens as 'Back Camera' or includes 'zoom'
                let selectedDeviceId = null;

                // Search for a camera that explicitly mentions 'telephoto' or 'zoom'
                const telephotoCamera = videoInputDevices.find(device => 
                    device.label.toLowerCase().includes('telephoto') || 
                    device.label.toLowerCase().includes('zoom')                                              
                );
                
                if (telephotoCamera) {
                    selectedDeviceId = telephotoCamera.deviceId;
                } else {
                    // Fallback: If no explicit telephoto, pick the very last camera in the list
                    // (On iOS, the last camera is typically the highest zoom/optical lens)
                    selectedDeviceId = videoInputDevices[videoInputDevices.length - 1].deviceId;
                }
                
                console.log("Selected Lens:", selectedDeviceId);
                
                // 2. Start decoding with specific constraints for focus
                const constraints = {
                    video: {
                        deviceId: { exact: selectedDeviceId },
                        // These help the iPhone prioritize sharpness over frame rate
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: "environment"
                    }
                };
                
                codeReader.decodeFromConstraints(constraints, 'video', (result, err) => {
                    if (result) {
                        activeCode = result.text;
                        document.getElementById('codeDisplay').innerText = result.text;
                        document.getElementById('controlPanel').style.display = "block";
                        document.getElementById('beep').play();
                        codeReader.reset();
                    }
                });
                document.getElementById('status').innerText = "";
            
            } catch (err) {
                console.error("Camera selection error:", err);
                alert("Could not access the telephoto lens. Ensure permissions are granted.");
            }
        }
        
        // function stopScanner() {
        //     codeReader.reset();
        // }

        startScanner();
    </script>
</body>
</html>
