<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUE Inventory</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: system-ui; text-align: center; background: #fafafa; padding: 20px; }
        #reader { width: 100%; max-width: 400px; margin: auto; border-radius: 12px; }
        .panel { display: none; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 20px; }
        button { padding: 15px 25px; margin: 10px; border: none; border-radius: 8px; font-weight: bold; color: white; }
        .btn-in { background: #27ae60; }
        .btn-out { background: #c0392b; }
        #status { margin-top: 15px; font-weight: 600; }
    </style>
</head>
<body>
    <h1>NUE Inventory Scanner</h1>
    <div id="scanner-container">
        <video id="video" style="width: 100%; max-width: 400px; border-radius: 10px;"></video>
    </div>
    <div id="status">Ready to scan</div>

    <div id="controlPanel" class="panel">
        <p>Item: <span id="codeDisplay">---</span></p>
        <button class="btn-in" onclick="sendToGoogle('IN')">Stock IN (+1)</button>
        <button class="btn-out" onclick="sendToGoogle('OUT')">Stock OUT (-1)</button>
        <button style="background:#7f8c8d" onclick="restartScanner()">Scan New</button>
    </div>

    <audio id="beep" src="https://actions.google.com/sounds/v1/communication/notification_high_intensity.ogg"></audio>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyvM2zdHvX3SWi4YdPea--jeYyqGuQyQ0fGXgUodIugr7F37-E5iBYzT8Lec6_cMhxk/exec";
        const codeReader = new ZXing.BrowserMultiFormatReader();
        const videoElement = document.getElementById('video');
        let activeCode = "";

        // function start() {
        //     scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
        //         activeCode = text;
        //         document.getElementById('codeDisplay').innerText = text;
        //         document.getElementById('controlPanel').style.display = "block";
        //         scanner.stop(); 
        //     });
        // }

        async function sendToGoogle(action) {
            document.getElementById('status').innerText = "Sending to Database...";
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Critical for Google Apps Script redirects
                    body: JSON.stringify({ barcode: activeCode, action: action })
                });
                
                // Note: with no-cors, we can't read the JSON response directly, 
                // but the data will still be updated in the Sheet.
                document.getElementById('beep').play();
                document.getElementById('status').innerText = "Update Sent!";
            } catch (err) {
                document.getElementById('status').innerText = "Error!";
            }
        }

        // function restartScanner() {
        //     document.getElementById('controlPanel').style.display = "none";
        //     start();
        // }
        
        async function startScanner() {
            try {
                // Get all video devices
                const videoInputDevices = await codeReader.listVideoInputDevices();
                // Select the back camera (usually the last one on iPhones)
                const selectedDeviceId = videoInputDevices[videoInputDevices.length - 3].deviceId;
            
                codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                    if (result) {
                        console.log("Scanned:", result.text);
                        activeCode = result.text;
          
                        // Trigger your UI and play sound
                        document.getElementById('codeDisplay').innerText = result.text;
                        document.getElementById('controlPanel').style.display = "block";
                    
                        // Stop scanning to save battery
                        codeReader.reset();
                    }
                });
            } catch (err) {
                console.error("Camera Error:", err);
            }
        }
        
        function stopScanner() {
            codeReader.reset();
        }

        startScanner();
    </script>
</body>
</html>
